{% extends "base.html" %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/manage_profile.css' %}">
{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">

<div class="settings-wrapper" role="main">
  <div class="settings-container">

    <!-- Breadcrumbs -->
    <nav class="breadcrumbs" aria-label="Breadcrumb">
      <ol>
        <li><a href="{% url 'core:profile' %}">Profile</a></li>
        <li aria-current="page">Account Settings</li>
      </ol>
    </nav>

    <!-- Header -->
    <div class="settings-header">
      <a href="{% url 'core:home' %}" class="back-button" aria-label="Back to Home Page">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Back</span>
      </a>
      <h1>Account Settings</h1>
    </div>

    <!-- Alerts -->
    {% if messages %}
      <div class="alerts" role="status" aria-live="polite">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Form -->
    <form method="post" action="" enctype="multipart/form-data" class="settings-form" novalidate>
      {% csrf_token %}

      <div class="settings-grid">

        <!-- Profile Picture Card -->
        <section class="form-card">
          <div class="card-header">
            <h3>Profile Picture</h3>
          </div>
          <div class="card-body">
            <div class="avatar-section">
              <div class="avatar-container">
                <div id="avatarDrop" class="avatar-preview" tabindex="0">
                  <img 
                    id="avatarPreview" 
                    alt="Profile photo"
                    src="{% if profile.avatar_url %}{{ profile.avatar_url.url }}{% else %}{% static 'imgs/avatar_placeholder.jpg' %}{% endif %}"
                    data-placeholder="{% static 'imgs/avatar_placeholder.jpg' %}">
                </div>

                <div class="avatar-actions">
                  <label for="avatar-upload" class="upload-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M.5 9.9a.5.5 0 0 1 .5.5v3.6a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V10.4a.5.5 0 0 1 1 0v3.6A2 2 0 0 1 14 16H2a2 2 0 0 1-2-2v-3.6a.5.5 0 0 1 .5-.5z"/>
                      <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3.182 3.182a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.172 5.036a.5.5 0 1 1-.708-.708l3.182-3.182z"/>
                    </svg>
                    <span>Choose Photo</span>
                  </label>

                  <input type="file" id="avatar-upload" name="avatar" class="file-input" accept="image/png, image/jpeg">

                  <button type="button" class="btn-reset" id="avatarReset">Reset</button>
                  <button type="button" class="btn-remove" id="avatarRemove">Remove Photo</button>
                </div>

                <p class="upload-hint">JPG or PNG, max 5MB. Drag & drop supported.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Personal Information Card -->
        <section class="form-card">
          <div class="card-header">
            <h3>Personal Information</h3>
          </div>
          <div class="card-body">
            <div class="form-row personal-info">
              <div class="form-group">
                <label for="first_name">First Name</label>
                <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" required>
                <small class="field-hint">Use your real first name.</small>
              </div>

              <div class="form-group">
                <label for="last_name">Last Name</label>
                <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" required>
              </div>

              <div class="form-group">
                <label for="middle_initial">M.I.</label>
                <input type="text" id="middle_initial" name="middle_initial" maxlength="1" value="{{ user.userprofile.middle_initial|default:'' }}" pattern="[A-Za-z]">
              </div>
            </div>
          </div>
        </section>

        <!-- Account Details Card -->
        <section class="form-card">
          <div class="card-header">
            <h3>Account Details</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label for="username">Username</label>
              <input id="username" type="text" name="username" value="{{ request.user.username }}" required autocomplete="username">
            </div>

            <div class="form-group">
              <label for="email">Email Address</label>
              <input id="email" type="email" name="email" value="{{ request.user.email }}" required autocomplete="email" inputmode="email">
            </div>

            <div class="form-group">
              <label for="phone_number">Phone Number</label>
              <input id="phone_number" type="tel" name="phone_number" value="{{ profile.phone_number|default:'' }}" placeholder="+63XXXXXXXXXX" pattern="^\+63[0-9]{10}$" aria-describedby="phoneHelp">
              <small id="phoneHelp" class="field-hint">Format: +63XXXXXXXXXX (11 digits after +63)</small>
            </div>
          </div>
        </section>

        <!-- Bio Card -->
        <section class="form-card">
          <div class="card-header">
            <h3>Bio</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label for="bio">About You</label>
              <textarea id="bio" name="bio" maxlength="500" placeholder="Tell us about yourself...">{{ profile.bio|default:'' }}</textarea>
              <div class="char-counter" aria-live="polite">
                <span id="charRemaining">500</span> characters remaining
              </div>
            </div>
          </div>
        </section>

      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <a href="{% url 'core:profile' %}" class="btn btn-ghost">Cancel</a>
        <button type="submit" class="btn btn-primary" id="saveBtn">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Update Confirmation Modal -->
<div id="updateModal" class="update-modal">
  <div class="modal-content">
    <h3>Confirm Update</h3>
    <p>Are you sure you want to update your profile? This action cannot be undone.</p>
    <div class="modal-actions">
      <button id="cancelUpdate" class="btn-cancel">Cancel</button>
      <button id="confirmUpdate" class="btn-confirm">Yes, Update</button>
    </div>
  </div>
</div>

<script src="{% static 'js/manage_profile.js' %}" defer></script>
{% endblock %}
